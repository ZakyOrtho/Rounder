<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Patient Records</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f4f7f9; color: #333; margin: 0; padding: 20px; font-size: 16px; }
        .container { max-width: 1400px; margin: 0 auto; }
        h1 { text-align: center; color: #2c3e50; }
        #patient-counter { text-align: center; color: #555; font-size: 1.2em; margin-top: -10px; margin-bottom: 25px; }
        .patient-card { background-color: #ffffff; border: 1px solid #d1d9e0; border-radius: 8px; padding: 20px; margin-bottom: 20px; box-shadow: 0 4px 8px rgba(0,0,0,0.05); }
        .header-info, .patient-data-sections { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 20px; }
        .checklist-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
        .checklist-column { padding: 15px; border-radius: 5px; background-color: #f8f9fa; }
        h2 { font-size: 1.1em; color: #34495e; border-bottom: 2px solid #4a90e2; padding-bottom: 5px; margin-top: 0; margin-bottom: 15px; }
        .form-group { display: flex; flex-direction: column; margin-bottom: 12px; }
        label { font-weight: 600; margin-bottom: 5px; font-size: 0.9em; color: #555; }
        input[type="text"], textarea { padding: 10px 12px; border: 1px solid #ccc; border-radius: 4px; font-size: 1em; width: 100%; box-sizing: border-box; }
        textarea { resize: vertical; min-height: 60px; }
        .checkbox-group { flex-direction: row; align-items: center; justify-content: space-between; }
        .checkbox-group .check-item { display: flex; align-items: center; flex-shrink: 0; }
        .checkbox-group label { margin: 0 0 0 8px; white-space: nowrap; }
        .checkbox-group .notes-field { margin-left: 15px; }
        input[type="checkbox"] { width: 22px; height: 22px; cursor: pointer; vertical-align: middle; accent-color: #28a745; }
        .op-day-group { display: flex; align-items: center; gap: 20px; margin-top: 10px; }
        .op-day-group label { margin: 0 0 0 5px; }
        .post-op-day-field { display: none; margin-left: auto; }
        .actions { text-align: right; margin-top: 20px; }
        .btn { padding: 10px 20px; border: none; border-radius: 5px; font-size: 1em; cursor: pointer; transition: background-color 0.2s; }
        .btn:disabled { background-color: #ccc; cursor: not-allowed; }
        .btn-add { background-color: #28a745; color: white; display: block; margin: 20px auto; }
        .btn-delete { background-color: #dc3545; color: white; }
        .io-container { display: flex; justify-content: center; gap: 15px; margin-bottom: 20px; padding: 15px; background-color: #e9ecef; border-radius: 8px; }
        .btn-export { background-color: #007bff; color: white; }
        .btn-import { background-color: #6c757d; color: white; }
        .btn-undo { background-color: #ffc107; color: black; }
    </style>
</head>
<body>

    <div class="container">
        <h1>Patient Records</h1>
        <div class="io-container">
            <button id="export-btn" class="btn btn-export">Save & Export Data</button>
            <button id="import-btn" class="btn btn-import">Import Data</button>
            <button id="undo-btn" class="btn btn-undo" disabled>Undo</button>
        </div>
        
        <!-- THIS HIDDEN INPUT IS REQUIRED FOR THE IMPORT BUTTON TO WORK -->
        <input type="file" id="import-file-input" accept=".json" style="display: none;">

        <h2 id="patient-counter"></h2>
        <div id="patient-list"></div>
        <button id="add-patient-btn" class="btn btn-add">Add New Patient</button>
    </div>

    <template id="patient-template">
        <!-- Template is identical -->
        <div class="patient-card">
            <div class="header-info">
                <div class="form-group"><label>Name:</label><input type="text" data-field="name"></div>
                <div class="form-group"><label>Age:</label><input type="text" data-field="age"></div>
                <div class="form-group"><label>Consultant:</label><input type="text" data-field="consultant"></div>
                <div class="form-group"><label>Floor:</label><input type="text" data-field="floor"></div>
            </div>
            <div class="patient-data-sections">
                <div class="form-group"><label>Diagnosis:</label><textarea data-field="diagnosis"></textarea></div>
                <div class="form-group"><label>Medical Hx:</label><textarea data-field="medicalHx"></textarea></div>
                <div class="form-group">
                    <label>OP Day:</label>
                    <div class="op-day-group" data-field="opDay">
                        <span><input type="radio" class="op-day-radio" value="pre" checked><label>Pre</label></span>
                        <span><input type="radio" class="op-day-radio" value="post"><label>Post</label></span>
                        <div class="post-op-day-field"><input type="text" placeholder="Which day?"></div>
                    </div>
                </div>
            </div>
            <div class="checklist-container">
                <div class="checklist-column" data-section="labs">
                    <h2>Lab Results & Vitals</h2>
                    <div class="form-group"><label>HB:</label><input type="text" data-field="hb"></div>
                    <div class="form-group"><label>INR:</label><input type="text" data-field="inr"></div>
                    <div class="form-group"><label>Creatinine:</label><input type="text" data-field="creatinine"></div>
                    <div class="form-group"><label>ALT:</label><input type="text" data-field="alt"></div>
                    <div class="form-group"><label>Virology:</label><input type="text" data-field="virology"></div>
                    <div class="form-group checkbox-group" data-field="ecg"><div class="check-item"><input type="checkbox"><label>ECG:</label></div><input type="text" class="notes-field" placeholder="Notes..."></div>
                    <div class="form-group checkbox-group" data-field="echo"><div class="check-item"><input type="checkbox"><label>ECHO, EF:</label></div><input type="text" class="notes-field" placeholder="Notes..."></div>
                    <div class="form-group"><label>Blood units:</label><input type="text" data-field="bloodUnits"></div>
                </div>
                <div class="checklist-column" data-section="preOp">
                    <h2>Pre-Operative Preparation</h2>
                    <div class="form-group checkbox-group" data-field="skinCondition"><div class="check-item"><input type="checkbox"><label>Skin condition:</label></div><input type="text" class="notes-field" placeholder="Notes..."></div>
                    <div class="form-group checkbox-group" data-field="shaving"><div class="check-item"><input type="checkbox"><label>Shaving & shower:</label></div><input type="text" class="notes-field" placeholder="Notes..."></div>
                    <div class="form-group checkbox-group" data-field="consent"><div class="check-item"><input type="checkbox"><label>Consent:</label></div><input type="text" class="notes-field" placeholder="Notes..."></div>
                    <div class="form-group checkbox-group" data-field="sideMark"><div class="check-item"><input type="checkbox"><label>Side Mark:</label></div><input type="text" class="notes-field" placeholder="Notes..."></div>
                    <div class="form-group checkbox-group" data-field="preAntibiotics"><div class="check-item"><input type="checkbox"><label>Pre-Antibiotics:</label></div><input type="text" class="notes-field" placeholder="Notes..."></div>
                    <div class="form-group checkbox-group" data-field="anticoagulants"><div class="check-item"><input type="checkbox"><label>Anticoagulants:</label></div><input type="text" class="notes-field" placeholder="Notes..."></div>
                    <div class="form-group checkbox-group" data-field="neuro"><div class="check-item"><input type="checkbox"><label>Neuro intact:</label></div><input type="text" class="notes-field" placeholder="Notes..."></div>
                    <div class="form-group checkbox-group" data-field="vascular"><div class="check-item"><input type="checkbox"><label>Vascular intact:</label></div><input type="text" class="notes-field" placeholder="Notes..."></div>
                    <div class="form-group checkbox-group" data-field="instruments"><div class="check-item"><input type="checkbox"><label>Instruments:</label></div><input type="text" class="notes-field" placeholder="Notes..."></div>
                </div>
                <div class="checklist-column" data-section="postOp">
                    <h2>Post-Operative Care</h2>
                    <div class="form-group"><label>Post HB:</label><input type="text" data-field="postHb"></div>
                    <div class="form-group"><label>Drain:</label><input type="text" data-field="drain"></div>
                    <div class="form-group checkbox-group" data-field="xrays"><div class="check-item"><input type="checkbox"><label>X-rays:</label></div><input type="text" class="notes-field" placeholder="Notes..."></div>
                    <div class="form-group"><label>Dressing:</label><input type="text" data-field="dressing"></div>
                    <div class="form-group checkbox-group" data-field="neuro"><div class="check-item"><input type="checkbox"><label>Neuro intact:</label></div><input type="text" class="notes-field" placeholder="Notes..."></div>
                    <div class="form-group checkbox-group" data-field="vascular"><div class="check-item"><input type="checkbox"><label>Vascular intact:</label></div><input type="text" class="notes-field" placeholder="Notes..."></div>
                    <div class="form-group checkbox-group" data-field="instructions"><div class="check-item"><input type="checkbox"><label>Instructions:</label></div><textarea class="notes-field" placeholder="Add instructions..."></textarea></div>
                    <div class="form-group checkbox-group" data-field="discharge"><div class="check-item"><input type="checkbox"><label>Discharge notes:</label></div><textarea class="notes-field" placeholder="Add discharge notes..."></textarea></div>
                </div>
            </div>
            <div class="actions"><button class="btn btn-delete">Delete Patient</button></div>
        </div>
    </template>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- ELEMENT SELECTORS ---
            const addPatientBtn = document.getElementById('add-patient-btn');
            const patientList = document.getElementById('patient-list');
            const patientTemplate = document.getElementById('patient-template');
            const patientCounter = document.getElementById('patient-counter');
            const exportBtn = document.getElementById('export-btn');
            const importBtn = document.getElementById('import-btn');
            const importFileInput = document.getElementById('import-file-input');
            const undoBtn = document.getElementById('undo-btn');
            
            // --- STATE MANAGEMENT ---
            let historyStack = [];
            const MAX_HISTORY_STATES = 5;

            // --- UNDO & HISTORY FUNCTIONS ---
            const updateUndoButton = () => {
                undoBtn.disabled = historyStack.length === 0;
            };

            const recordState = () => {
                const currentState = Array.from(document.querySelectorAll('.patient-card')).map(getCardData);
                historyStack.push(currentState);
                if (historyStack.length > MAX_HISTORY_STATES) {
                    historyStack.shift();
                }
                updateUndoButton();
            };

            const handleUndo = () => {
                if (historyStack.length > 0) {
                    const lastState = historyStack.pop();
                    renderFromState(lastState);
                    updateUndoButton();
                }
            };
            
            // --- CORE UI & DATA FUNCTIONS ---
            const updatePatientCount = () => {
                patientCounter.textContent = `Total Patients: ${patientList.children.length}`;
            };
            
            const createPatientCard = (patientData = {}) => {
                const newCard = patientTemplate.content.cloneNode(true).querySelector('.patient-card');
                
                newCard.querySelectorAll('input, textarea').forEach(el => el.addEventListener('change', recordState));
                
                newCard.querySelector('.btn-delete').addEventListener('click', () => {
                    if (window.confirm("Are you sure you want to delete this patient record?")) {
                        recordState();
                        newCard.remove();
                        updatePatientCount();
                    }
                });

                populateCard(newCard, patientData);
                return newCard;
            };
            
            const handleAddNewPatient = () => {
                recordState();
                const newCard = createPatientCard();
                patientList.appendChild(newCard);
                updatePatientCount();
            };

            const renderFromState = (stateData) => {
                patientList.innerHTML = '';
                if (stateData && stateData.length > 0) {
                    stateData.forEach(patient => {
                        const card = createPatientCard(patient);
                        patientList.appendChild(card);
                    });
                }
                updatePatientCount();
            };
            
            // --- DATA EXTRACTION & POPULATION ---
            const getCardData = (card) => {
                const data = { labs: {}, preOp: {}, postOp: {} };
                card.querySelectorAll('[data-field]').forEach(el => {
                    if (el.matches('.checkbox-group, .op-day-group')) return;
                    data[el.dataset.field] = el.value;
                });
                card.querySelectorAll('.checkbox-group').forEach(group => {
                    const section = group.closest('[data-section]').dataset.section;
                    const field = group.dataset.field;
                    data[section][field] = {
                        checked: group.querySelector('input[type="checkbox"]').checked,
                        notes: group.querySelector('.notes-field, textarea').value
                    };
                });
                const opDayGroup = card.querySelector('[data-field="opDay"]');
                data.opDay = {
                    type: opDayGroup.querySelector('.op-day-radio:checked').value,
                    details: opDayGroup.querySelector('.post-op-day-field input').value
                };
                return data;
            };

            const populateCard = (card, data) => {
                card.querySelectorAll('[data-field]').forEach(el => {
                    if (el.matches('.checkbox-group, .op-day-group')) return;
                    if (data && data[el.dataset.field] !== undefined) el.value = data[el.dataset.field];
                });
                card.querySelectorAll('.checkbox-group').forEach(group => {
                    const section = group.closest('[data-section]').dataset.section;
                    const field = group.dataset.field;
                    if (data && data[section] && data[section][field]) {
                        group.querySelector('input[type="checkbox"]').checked = data[section][field].checked;
                        group.querySelector('.notes-field, textarea').value = data[section][field].notes;
                    }
                });
                if (data && data.opDay) {
                    const opDayGroup = card.querySelector('[data-field="opDay"]');
                    opDayGroup.querySelector(`input[value="${data.opDay.type}"]`).checked = true;
                    if (data.opDay.type === 'post') {
                        opDayGroup.querySelector('.post-op-day-field').style.display = 'block';
                        opDayGroup.querySelector('.post-op-day-field input').value = data.opDay.details;
                    }
                }
                 card.querySelectorAll('.op-day-radio').forEach(radio => {
                    radio.addEventListener('change', (event) => {
                         card.querySelector('.post-op-day-field').style.display = (event.target.value === 'post') ? 'block' : 'none';
                    });
                });
            };
            
            // --- IMPORT/EXPORT FUNCTIONS ---
            const handleExport = () => {
                const allData = Array.from(document.querySelectorAll('.patient-card')).map(getCardData);
                const a = document.createElement('a');
                a.href = URL.createObjectURL(new Blob([JSON.stringify(allData, null, 2)], { type: 'application/json' }));
                a.download = 'patient_data.json';
                a.click();
                URL.revokeObjectURL(a.href);
            };

            const handleImport = (event) => {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const importedData = JSON.parse(e.target.result);
                        if (!Array.isArray(importedData)) throw new Error("JSON is not an array.");
                        recordState();
                        renderFromState(importedData);
                        alert('Data successfully imported!');
                    } catch (error) {
                        alert('Error: Could not import data. Please ensure the file is valid.');
                    }
                };
                reader.readAsText(file);
                event.target.value = null; 
            };
            
            // --- INITIALIZATION ---
            addPatientBtn.addEventListener('click', handleAddNewPatient);
            undoBtn.addEventListener('click', handleUndo);
            exportBtn.addEventListener('click', handleExport);
            importBtn.addEventListener('click', () => importFileInput.click());
            importFileInput.addEventListener('change', handleImport);

            renderFromState([{}]);
            historyStack = [];
            updateUndoButton();
        });
    </script>
</body>
</html>